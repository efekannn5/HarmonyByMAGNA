{% extends "layout.html" %}

{% block content %}
<style>
.operator-dashboard-layout {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 1.5rem;
    height: calc(100vh - 145px);
    overflow: hidden;
}

.task-list-panel {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.task-list-header {
    background: #DA291C;
    color: white;
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.task-list-header h2 {
    margin: 0 0 0.25rem 0;
    font-size: 1.125rem;
    font-weight: 700;
}

.task-list-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 0.875rem;
}

.task-list-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.task-group-section {
    margin-bottom: 1.5rem;
}

.task-group-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #6b7280;
    font-weight: 700;
    margin-bottom: 0.75rem;
    padding-left: 0.5rem;
}

.task-card-compact {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.task-card-compact:hover {
    border-color: #4298B5;
    box-shadow: 0 4px 12px rgba(66, 152, 181, 0.15);
    transform: translateY(-2px);
}

.task-card-compact.active {
    border-color: #DA291C;
    background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
    box-shadow: 0 0 0 3px rgba(218, 41, 28, 0.1);
}

.task-card-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

.task-card-status {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
}

.task-card-status.status-pending {
    background: rgba(245, 158, 11, 0.15);
    color: #b45309;
}

.task-card-meta {
    font-size: 0.75rem;
    color: #6b7280;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.shipping-tag {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

.tag-asn { background: #ecfccb; color: #365314; }
.tag-irsaliye { background: #fecaca; color: #991b1b; }
.tag-both { background: #e0e7ff; color: #3730a3; }

/* Right Panel - Task Detail with ASN Form */
.task-detail-panel {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.task-detail-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    flex-direction: column;
    color: #9ca3af;
}

.task-detail-empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.task-detail-content-container {
    flex: 1;
    overflow-y: auto;
    display: none;
}

.task-detail-content-container.active {
    display: block;
}

@media (max-width: 1200px) {
    .operator-dashboard-layout {
        grid-template-columns: 300px 1fr;
    }
}

/* Real-time Notification Styles */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.6;
    }
}

.notification-flash {
    animation: slideInRight 0.5s ease-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.badge.bg-light.pulse-badge {
    animation: pulse 2s infinite;
}
</style>

<div class="operator-dashboard-layout">
    <!-- Sol Panel: GÃ¶rev Listesi -->
    <div class="task-list-panel">
        <div class="task-list-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0;">ğŸ“‹ Aktif Sevkiyatlar</h2>
                    <p style="margin: 0.25rem 0 0 0;">Grup adÄ±na gÃ¶re listelenir</p>
                </div>
                <div>
                    <button type="button" id="notification-toggle-btn" class="btn btn-light btn-sm" onclick="toggleNotifications()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                        <i class="bi bi-bell-fill"></i>
                    </button>
                    <span class="badge bg-light text-dark ms-1 pulse-badge" title="Otomatik yenileme aktif" style="font-size: 0.7rem;">
                        <i class="bi bi-arrow-repeat"></i> 3s
                    </span>
                </div>
            </div>
        </div>
        <div class="task-list-scroll">
            {% if pending_tasks %}
            <div class="task-group-section">
                <div class="task-group-label">Bekleyen Sevkiyatlar</div>
                {% for task in pending_tasks %}
                <div class="task-card-compact" data-part="{{ task.part_number }}" onclick="loadTaskDetail('{{ task.part_number }}', this)">
                    <div class="task-card-title">{{ task.display_name or task.part_number }}</div>
                    <span class="task-card-status status-pending">â— Beklemede</span>
                    <div class="task-card-meta">
                        <div>ğŸ“… {{ task.created_at|local_dt }}</div>
                        <div>ï¿½ {{ task.total_dollys }} Dolly / ğŸ“¦ {{ task.total_items }} VIN</div>
                        <div><span class="shipping-tag tag-{{ task.group_tag }}">
                            {% if task.group_tag == "asn" %}ASN{% elif task.group_tag == "irsaliye" %}Ä°rsaliye{% else %}ASN + Ä°rsaliye{% endif %}
                        </span></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if not pending_tasks and not assigned_tasks and not completed_tasks %}
            <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“­</div>
                <p>HenÃ¼z gÃ¶rev bulunmuyor</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- SaÄŸ Panel: Task Detail (Direkt iÃ§erik, iframe yok) -->
    <div class="task-detail-panel">
        <!-- Empty State -->
        <div class="task-detail-empty" id="emptyState">
            <div class="task-detail-empty-icon">ğŸ“‹</div>
            <h3>Soldan bir gÃ¶rev seÃ§in</h3>
            <p style="color: #9ca3af; font-size: 0.9rem; margin-top: 0.5rem;">DetaylarÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in bir part numarasÄ±na tÄ±klayÄ±n</p>
        </div>
        
        <!-- Task Detail Content (iframe olmadan, direkt iÃ§erik) -->
        <div class="task-detail-content-container" id="taskDetailContainer" style="display: none; flex: 1; overflow-y: auto; padding: 1.5rem;">
            <!-- Content will be loaded here via JavaScript -->
        </div>
    </div>
</div>

<script>
// ============================================
// REAL-TIME NOTIFICATION SYSTEM
// ============================================
var lastTaskCount = {{ pending_tasks|length }};
var lastTaskIds = [
    {% for task in pending_tasks %}
    "{{ task.part_number }}"{{ "," if not loop.last else "" }}
    {% endfor %}
];
var notificationSound = null;
var isPageVisible = true;
var pollInterval = null;
var notificationsEnabled = localStorage.getItem('operatorNotifications') !== 'false';

// Ses dosyasÄ± hazÄ±rlama
function initNotificationSound() {
    try {
        notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
    } catch (e) {
        console.error('Ses baÅŸlatma hatasÄ±:', e);
    }
}

// Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼k kontrolÃ¼
document.addEventListener('visibilitychange', function() {
    isPageVisible = !document.hidden;
});

// Browser notification izni isteme
function requestNotificationPermission() {
    if (!('Notification' in window)) {
        console.log('âŒ Bu tarayÄ±cÄ± bildirim desteklemiyor');
        return;
    }
    
    console.log('ğŸ”” Notification permission:', Notification.permission);
    
    if (Notification.permission === 'default') {
        Notification.requestPermission().then(function(permission) {
            console.log('âœ… Bildirim izni sonucu:', permission);
            if (permission === 'granted') {
                showBrowserNotification('Bildirimler Aktif', 'Yeni gÃ¶rev geldiÄŸinde bildirim alacaksÄ±nÄ±z');
            }
        });
    } else if (Notification.permission === 'granted') {
        console.log('âœ… Bildirim izni zaten verilmiÅŸ');
    } else {
        console.log('âŒ Bildirim izni reddedilmiÅŸ');
    }
}

// Browser notification gÃ¶sterme
function showBrowserNotification(title, message) {
    if (!('Notification' in window) || Notification.permission !== 'granted') {
        return;
    }
    var notification = new Notification(title, {
        body: message,
        icon: '/static/favicon.ico',
        tag: 'harmony-operator',
        requireInteraction: false
    });
    notification.onclick = function() {
        window.focus();
        notification.close();
    };
    setTimeout(function() {
        notification.close();
    }, 5000);
}

// Bildirim sesi Ã§alma
function playNotificationSound() {
    if (notificationSound && notificationsEnabled) {
        try {
            notificationSound.currentTime = 0;
            notificationSound.play().catch(function(err) {
                console.log('Ses Ã§alma hatasÄ±:', err);
            });
        } catch (e) {
            console.error('Ses Ã§alma hatasÄ±:', e);
        }
    }
}

// Aktif gÃ¶revleri kontrol et
function checkForNewTasks() {
    fetch('/api/operator/active-tasks-status', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin'
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (!data.success) {
            console.error('âŒ API hatasÄ±:', data.error);
            return;
        }
        
        var currentTaskCount = data.count;
        var currentTaskIds = data.tasks.map(function(t) { return t.part_number; });
        
        console.log('ğŸ“Š Polling: Åu anki=' + currentTaskCount + ', Ã–nceki=' + lastTaskCount);
        console.log('ğŸ“‹ GÃ¶rev ID\'leri:', currentTaskIds.join(', '));
        
        var hasNewTask = false;
        
        if (currentTaskCount > lastTaskCount) {
            hasNewTask = true;
            console.log('ğŸ†• YENÄ° GÃ–REV TESPÄ°T EDÄ°LDÄ°! GÃ¶rev sayÄ±sÄ± arttÄ±:', lastTaskCount, 'â†’', currentTaskCount);
        } else if (currentTaskCount === lastTaskCount && currentTaskCount > 0) {
            for (var i = 0; i < currentTaskIds.length; i++) {
                if (lastTaskIds.indexOf(currentTaskIds[i]) === -1) {
                    hasNewTask = true;
                    console.log('ğŸ†• YENÄ° GÃ–REV TESPÄ°T EDÄ°LDÄ°! Yeni ID bulundu:', currentTaskIds[i]);
                    break;
                }
            }
        }
        
        if (hasNewTask) {
            console.log('ğŸ‰ YENÄ° GÃ–REV VAR - BÄ°LDÄ°RÄ°M BAÅLATIYOR...');
            playNotificationSound();
            
            if (!isPageVisible) {
                var message = currentTaskCount + ' aktif gÃ¶rev var';
                if (data.tasks.length > 0) {
                    message += ' (Son: ' + data.tasks[0].eol_name + ')';
                }
                console.log('ğŸ“± Browser notification gÃ¶steriliyor:', message);
                showBrowserNotification('ğŸ†• Yeni GÃ¶rev!', message);
            } else {
                console.log('ğŸ‘ï¸ Sayfa gÃ¶rÃ¼nÃ¼r, sadece ses Ã§alÄ±nÄ±yor');
            }
            
            setTimeout(function() {
                console.log('ğŸ”„ Sayfa yenileniyor...');
                window.location.reload();
            }, 1000);
        } else {
            console.log('â„¹ï¸ DeÄŸiÅŸiklik yok');
        }
        
        lastTaskCount = currentTaskCount;
        lastTaskIds = currentTaskIds;
    })
    .catch(function(error) {
        console.error('âŒ Polling hatasÄ±:', error);
    });
}

// Bildirim toggle
function toggleNotifications() {
    notificationsEnabled = !notificationsEnabled;
    localStorage.setItem('operatorNotifications', notificationsEnabled ? 'true' : 'false');
    
    var btn = document.getElementById('notification-toggle-btn');
    if (btn) {
        btn.innerHTML = notificationsEnabled ? 
            '<i class="bi bi-bell-fill"></i>' : 
            '<i class="bi bi-bell-slash"></i>';
        btn.className = notificationsEnabled ? 'btn btn-light btn-sm' : 'btn btn-secondary btn-sm';
    }
}

// ============================================
// MEVCUT FONKSÄ°YONLAR
// ============================================
let currentPartNumber = null;

function loadTaskDetail(partNumber, cardElement) {
    // Remove active class from all cards
    document.querySelectorAll('.task-card-compact').forEach(card => {
        card.classList.remove('active');
    });
    
    // Add active class to clicked card
    if (cardElement) {
        cardElement.classList.add('active');
    }
    
    // Store current part number
    currentPartNumber = partNumber;
    
    // Hide empty state
    document.getElementById('emptyState').style.display = 'none';
    
    // Show task detail container
    const taskContainer = document.getElementById('taskDetailContainer');
    taskContainer.style.display = 'block';
    taskContainer.innerHTML = '<div style="text-align: center; padding: 3rem;"><div style="font-size: 2rem; margin-bottom: 1rem;">â³</div><p>YÃ¼kleniyor...</p></div>';
    
    // Fetch task detail content via AJAX
    fetch(`/operator/task/${partNumber}?embed=true`)
        .then(response => response.text())
        .then(html => {
            // Parse the HTML to extract body content
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const bodyContent = doc.body.innerHTML;
            
            // Inject the content
            taskContainer.innerHTML = bodyContent;
            
            // Re-execute scripts from the loaded content
            const scripts = taskContainer.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => 
                    newScript.setAttribute(attr.name, attr.value)
                );
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        })
        .catch(error => {
            console.error('Error loading task detail:', error);
            taskContainer.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #ef4444;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">âŒ</div>
                    <p>GÃ¶rev detaylarÄ± yÃ¼klenemedi</p>
                    <button onclick="loadTaskDetail('${partNumber}', null)" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4298B5; color: white; border: none; border-radius: 8px; cursor: pointer;">Tekrar Dene</button>
                </div>
            `;
        });
}

// Sayfa yÃ¼klendiÄŸinde real-time sistemi baÅŸlat
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Real-time notification system baÅŸlatÄ±lÄ±yor...');
    console.log('ğŸ“Š BaÅŸlangÄ±Ã§ gÃ¶rev sayÄ±sÄ±:', lastTaskCount);
    console.log('ğŸ“‹ BaÅŸlangÄ±Ã§ gÃ¶rev ID\'leri:', lastTaskIds.join(', '));
    
    // Ses sistemini baÅŸlat
    initNotificationSound();
    
    // Browser notification izni iste (DÄ°REK!)
    if ('Notification' in window) {
        console.log('ğŸ”” Mevcut bildirim izni:', Notification.permission);
        if (Notification.permission === 'default') {
            console.log('âš¡ Bildirim izni ÅŸimdi isteniyor...');
            requestNotificationPermission(); // Direkt Ã§aÄŸÄ±r, timeout yok!
        } else if (Notification.permission === 'granted') {
            console.log('âœ… Bildirim izni zaten verilmiÅŸ!');
        } else {
            console.log('âŒ Bildirim izni reddedilmiÅŸ. TarayÄ±cÄ± ayarlarÄ±ndan deÄŸiÅŸtirebilirsiniz.');
        }
    } else {
        console.log('âŒ Bu tarayÄ±cÄ± Notification API desteklemiyor');
    }
    
    // 3 saniyede bir polling baÅŸlat
    pollInterval = setInterval(checkForNewTasks, 3000);
    
    console.log('âœ… Polling baÅŸlatÄ±ldÄ± (3 saniye interval)');
    console.log('ğŸ”” Bildirimler:', notificationsEnabled ? 'AÃ§Ä±k' : 'KapalÄ±');
    
    // Bildirim buton durumunu gÃ¼ncelle
    var btn = document.getElementById('notification-toggle-btn');
    if (btn) {
        btn.innerHTML = notificationsEnabled ? 
            '<i class="bi bi-bell-fill"></i>' : 
            '<i class="bi bi-bell-slash"></i>';
        btn.className = notificationsEnabled ? 'btn btn-light btn-sm' : 'btn btn-secondary btn-sm';
    }
    
    console.log('ğŸ¯ Ä°lk polling 3 saniye sonra baÅŸlayacak...');
});

// Sayfa kapatÄ±lÄ±rken polling'i durdur
window.addEventListener('beforeunload', function() {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
});
</script>

{% endblock %}
