{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Bekleyen Sevkiyatlar (Forklift TamamladÄ±)</h2>
        <div>
            <button type="button" id="notification-toggle-btn" class="btn btn-success btn-sm" onclick="toggleNotifications()">
                <i class="bi bi-bell-fill"></i> Bildirimler AÃ§Ä±k
            </button>
            <span class="badge bg-info ms-2" title="Otomatik yenileme aktif">
                <i class="bi bi-arrow-repeat"></i> 3s
            </span>
        </div>
    </div>
    
    <div class="alert alert-info">
        <strong>Ä°ÅŸ AkÄ±ÅŸÄ±:</strong>
        <ol>
            <li>Forklift operatÃ¶r dolly'leri sÄ±rayla okuttu ve TIR'a yÃ¼kledi</li>
            <li>Forklift "YÃ¼kleme TamamlandÄ±" butonuna bastÄ±</li>
            <li><strong>Åžimdi sizin sÄ±ranÄ±z:</strong> Sefer No ve Plaka girin, ASN/Ä°rsaliye gÃ¶nderin</li>
        </ol>
        <div class="mt-2">
            <i class="bi bi-bell"></i> <strong>Yeni gÃ¶rev geldiÄŸinde:</strong> Otomatik bildirim alacak ve sayfa yenilenecektir.
        </div>
    </div>

    {% if pending_shipments %}
    <div class="row">
        {% for shipment in pending_shipments %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5>
                        <i class="bi bi-truck"></i> 
                        {{ shipment.loadingSessionId }}
                    </h5>
                    <small>Forklift: {{ shipment.forkliftUser or 'Bilinmiyor' }} | 
                           Tamamlanma: {{ shipment.completedAt }}</small>
                </div>
                <div class="card-body">
                    <h6>YÃ¼klenen Dolly'ler ({{ shipment.dollyCount }} adet) 
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleSelectAll({{ loop.index }})">
                            <i class="bi bi-check-square"></i> TÃ¼mÃ¼nÃ¼ SeÃ§/KaldÄ±r
                        </button>
                    </h6>
                    <div class="alert alert-warning alert-sm">
                        <i class="bi bi-info-circle"></i> Ä°sterseniz sadece bazÄ± dolly'leri seÃ§ip gÃ¶nderebilirsiniz (Partial Shipment)
                    </div>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th width="40">SeÃ§</th>
                                <th>SÄ±ra</th>
                                <th>Dolly No</th>
                                <th>VIN No</th>
                                <th>MÃ¼ÅŸteri</th>
                                <th>EOL</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dolly in shipment.dollys %}
                            <tr>
                                <td>
                                    <input type="checkbox" 
                                           class="form-check-input dolly-checkbox-{{ loop.parent.loop.index }}" 
                                           name="selected_dolly_ids" 
                                           value="{{ dolly.id }}"
                                           checked
                                           onchange="updateSelectedCount({{ loop.parent.loop.index }})">
                                </td>
                                <td><span class="badge bg-primary">{{ dolly.scanOrder }}</span></td>
                                <td><strong>{{ dolly.dollyNo }}</strong></td>
                                <td><code>{{ dolly.vinNo }}</code></td>
                                <td>{{ dolly.customerReferans or '-' }}</td>
                                <td>{{ dolly.eolName or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="alert alert-info alert-sm">
                        <span id="selected-count-{{ loop.index }}">{{ shipment.dollyCount }}</span> dolly seÃ§ildi
                    </div>

                    <hr>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Not:</strong> ASN gÃ¶nderme iÅŸlemi kaldÄ±rÄ±lmÄ±ÅŸtÄ±r. 
                        Sevkiyat tamamlama iÃ§in IT departmanÄ± ile iletiÅŸime geÃ§in.
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-secondary">
        <i class="bi bi-inbox"></i> Åžu anda bekleyen sevkiyat yok.
    </div>
    {% endif %}
</div>

<style>
.card {
    border: 2px solid #ffc107;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.card-header {
    font-weight: bold;
}

.table-sm td, .table-sm th {
    padding: 0.5rem;
}

code {
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
}

.alert-sm {
    padding: 0.5rem;
    font-size: 0.9em;
}

/* Real-time Notification Styles */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

.notification-flash {
    animation: slideInRight 0.5s ease-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

#notification-toggle-btn {
    transition: all 0.3s ease;
}

#notification-toggle-btn:hover {
    transform: scale(1.05);
}

.badge.bg-info {
    animation: pulse 2s infinite;
}
</style>

<script>
// ============================================
// REAL-TIME NOTIFICATION SYSTEM
// ============================================

var lastTaskCount = {{ pending_shipments|length }};
var lastTaskIds = [
    {% for ship in pending_shipments %}
    "{{ ship.loadingSessionId }}"{{ "," if not loop.last else "" }}
    {% endfor %}
];
var notificationSound = null;
var isPageVisible = true;
var pollInterval = null;
var notificationsEnabled = localStorage.getItem('operatorNotifications') !== 'false';

// Ses dosyasÄ± hazÄ±rlama
function initNotificationSound() {
    try {
        // Basit bildirim sesi (data URL ile)
        notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
    } catch (e) {
        console.error('Ses baÅŸlatma hatasÄ±:', e);
    }
}

// Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼k kontrolÃ¼
document.addEventListener('visibilitychange', function() {
    isPageVisible = !document.hidden;
    console.log('Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼k:', isPageVisible ? 'GÃ¶rÃ¼nÃ¼r' : 'Gizli');
});

// Browser notification izni isteme
function requestNotificationPermission() {
    if (!('Notification' in window)) {
        console.log('Bu tarayÄ±cÄ± bildirim desteklemiyor');
        return;
    }
    
    if (Notification.permission === 'default') {
        Notification.requestPermission().then(function(permission) {
            console.log('Bildirim izni:', permission);
            if (permission === 'granted') {
                showBrowserNotification('Bildirimler Aktif', 'Yeni gÃ¶rev geldiÄŸinde bildirim alacaksÄ±nÄ±z', 'success');
            }
        });
    }
}

// Browser notification gÃ¶sterme
function showBrowserNotification(title, message, icon) {
    if (!('Notification' in window) || Notification.permission !== 'granted') {
        return;
    }
    
    var iconUrl = icon === 'success' ? 'âœ…' : 'ðŸ“¦';
    
    var notification = new Notification(title, {
        body: message,
        icon: '/static/favicon.ico',
        badge: '/static/favicon.ico',
        tag: 'harmony-operator',
        requireInteraction: false,
        silent: false
    });
    
    notification.onclick = function() {
        window.focus();
        notification.close();
    };
    
    // 5 saniye sonra otomatik kapat
    setTimeout(function() {
        notification.close();
    }, 5000);
}

// Bildirim sesi Ã§alma
function playNotificationSound() {
    if (notificationSound && notificationsEnabled) {
        try {
            notificationSound.currentTime = 0;
            notificationSound.play().catch(function(err) {
                console.log('Ses Ã§alma hatasÄ±:', err);
            });
        } catch (e) {
            console.error('Ses Ã§alma hatasÄ±:', e);
        }
    }
}

// Aktif gÃ¶revleri kontrol et
function checkForNewTasks() {
    fetch('/api/operator/active-tasks-status', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (!data.success) {
            console.error('API hatasÄ±:', data.error);
            return;
        }
        
        var currentTaskCount = data.count;
        var currentTaskIds = data.tasks.map(function(t) { return t.part_number; });
        
        // Yeni gÃ¶rev var mÄ± kontrol et
        var hasNewTask = false;
        
        // Yeni gÃ¶rev sayÄ±sÄ± artmÄ±ÅŸsa
        if (currentTaskCount > lastTaskCount) {
            hasNewTask = true;
        } else if (currentTaskCount === lastTaskCount) {
            // AynÄ± sayÄ±da ama farklÄ± gÃ¶rev ID'leri varsa
            for (var i = 0; i < currentTaskIds.length; i++) {
                if (lastTaskIds.indexOf(currentTaskIds[i]) === -1) {
                    hasNewTask = true;
                    break;
                }
            }
        }
        
        if (hasNewTask) {
            console.log('ðŸ†• Yeni gÃ¶rev tespit edildi!');
            
            // Bildirim gÃ¶ster
            handleNewTaskNotification(data.tasks);
            
            // SayfayÄ± yenile
            setTimeout(function() {
                console.log('ðŸ”„ Sayfa yenileniyor...');
                window.location.reload();
            }, 1000);
        }
        
        // Son durumu kaydet
        lastTaskCount = currentTaskCount;
        lastTaskIds = currentTaskIds;
    })
    .catch(function(error) {
        console.error('Polling hatasÄ±:', error);
    });
}

// Yeni gÃ¶rev bildirimi
function handleNewTaskNotification(tasks) {
    if (!notificationsEnabled) {
        return;
    }
    
    // Ses Ã§al
    playNotificationSound();
    
    // Sayfa dÄ±ÅŸÄ±ndaysa browser notification gÃ¶ster
    if (!isPageVisible) {
        var taskCount = tasks.length;
        var message = taskCount + ' yeni gÃ¶rev bekleniyor';
        
        if (tasks.length > 0) {
            message += ' (' + tasks[0].group_or_eol + ')';
        }
        
        showBrowserNotification('ðŸ†• Yeni GÃ¶rev!', message, 'success');
    }
    
    // Ekranda flash mesajÄ± (sayfa gÃ¶rÃ¼nÃ¼rse)
    if (isPageVisible) {
        showFlashMessage('Yeni gÃ¶rev eklendi! Sayfa yenileniyor...', 'success');
    }
}

// Flash mesaj gÃ¶ster
function showFlashMessage(message, type) {
    var alertClass = 'alert-' + (type === 'success' ? 'success' : 'info');
    var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show notification-flash" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; animation: slideInRight 0.5s;">' +
        '<strong>ðŸ“¦ Harmony:</strong> ' + message +
        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
        '</div>';
    
    var container = document.querySelector('.container-fluid');
    if (container) {
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // 3 saniye sonra otomatik kaldÄ±r
        setTimeout(function() {
            var flash = document.querySelector('.notification-flash');
            if (flash) {
                flash.remove();
            }
        }, 3000);
    }
}

// Bildirim toggle butonu
function toggleNotifications() {
    notificationsEnabled = !notificationsEnabled;
    localStorage.setItem('operatorNotifications', notificationsEnabled ? 'true' : 'false');
    
    var btn = document.getElementById('notification-toggle-btn');
    if (btn) {
        btn.innerHTML = notificationsEnabled ? 
            '<i class="bi bi-bell-fill"></i> Bildirimler AÃ§Ä±k' : 
            '<i class="bi bi-bell-slash"></i> Bildirimler KapalÄ±';
        btn.className = notificationsEnabled ? 'btn btn-success btn-sm' : 'btn btn-secondary btn-sm';
    }
    
    showFlashMessage(
        notificationsEnabled ? 'Bildirimler aÃ§Ä±ldÄ± âœ…' : 'Bildirimler kapatÄ±ldÄ± ðŸ”•', 
        notificationsEnabled ? 'success' : 'warning'
    );
}

// Sayfa yÃ¼klendiÄŸinde baÅŸlat
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Real-time notification system baÅŸlatÄ±lÄ±yor...');
    console.log('ðŸ“Š BaÅŸlangÄ±Ã§ gÃ¶rev sayÄ±sÄ±:', lastTaskCount);
    console.log('ðŸ“‹ BaÅŸlangÄ±Ã§ gÃ¶rev ID\'leri:', lastTaskIds.join(', '));
    
    // Ses sistemini baÅŸlat
    initNotificationSound();
    
    // Browser notification izni iste (DÄ°REK!)
    if ('Notification' in window) {
        console.log('ðŸ”” Mevcut bildirim izni:', Notification.permission);
        if (Notification.permission === 'default') {
            console.log('âš¡ Bildirim izni ÅŸimdi isteniyor...');
            requestNotificationPermission(); // Direkt Ã§aÄŸÄ±r, timeout yok!
        } else if (Notification.permission === 'granted') {
            console.log('âœ… Bildirim izni zaten verilmiÅŸ!');
        } else {
            console.log('âŒ Bildirim izni reddedilmiÅŸ. TarayÄ±cÄ± ayarlarÄ±ndan deÄŸiÅŸtirebilirsiniz.');
        }
    }
    
    // 3 saniyede bir polling baÅŸlat
    pollInterval = setInterval(checkForNewTasks, 3000);
    
    console.log('âœ… Polling baÅŸlatÄ±ldÄ± (3 saniye interval)');
    console.log('ðŸ”” Bildirimler:', notificationsEnabled ? 'AÃ§Ä±k' : 'KapalÄ±');
    console.log('ðŸŽ¯ Ä°lk polling 3 saniye sonra baÅŸlayacak...');
});

// Sayfa kapatÄ±lÄ±rken polling'i durdur
window.addEventListener('beforeunload', function() {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
});

// ============================================
// MEVCUT FONKSÄ°YONLAR
// ============================================

function toggleSelectAll(shipmentIndex) {
    const checkboxes = document.querySelectorAll('.dolly-checkbox-' + shipmentIndex);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });
    
    updateSelectedCount(shipmentIndex);
}

function updateSelectedCount(shipmentIndex) {
    const checkboxes = document.querySelectorAll('.dolly-checkbox-' + shipmentIndex);
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    
    const countElement = document.getElementById('selected-count-' + shipmentIndex);
    if (countElement) {
        countElement.textContent = checkedCount;
    }
}

// Form validation before submit
var forms = document.querySelectorAll('form');
forms.forEach(form => {
    form.addEventListener('submit', function(e) {
        const checkboxes = form.querySelectorAll('input[name="selected_dolly_ids"]:checked');
        if (checkboxes.length === 0) {
            e.preventDefault();
            alert('En az bir dolly seÃ§melisiniz!');
            return false;
        }
    });
});
</script>
{% endblock %}
